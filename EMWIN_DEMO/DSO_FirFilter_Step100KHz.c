/*
*********************************************************************************************************
*	                                  
*	模块名称 : Fir低通滤波器设计
*	文件名称 : DSO_FirFilter_Step100KHz.c
*	版    本 : V1.0
*	说    明 : 用于示波器波形显示的滤波，采用80阶Fir滤波器。 
*              使用条件：Fs(采样率) = 2Msps时，即Scale窗口显示500ns时，Fc(截止频率)的选择，支持截止频率
*              Fc = 100KHz
*              Fc = 200KHz
*              Fc = 300KHz
*              Fc = 400KHz
*              Fc = 500KHz
*              Fc = 600KHz
*              Fc = 700KHz 
*
*	修改记录 :
*		版本号    日期          作者           说明
*		V1.0    2018-01-06     Eric2013        首发 
*                                           
*	Copyright (C), 2018-2028, 安富莱电子 www.armfly.com
*
*********************************************************************************************************
*/
#include "includes.h"
#include "MainTask.h"



/*
*********************************************************************************************************
*	                                     变量
*********************************************************************************************************
*/
float32_t *FirDataInput;    /* 采样点 TEST_LENGTH_SAMPLES*/
float32_t *FirDataOutput;   /* 滤波后的输出 TEST_LENGTH_SAMPLES*/
float32_t *firStateF32;     /* 状态缓存，大小BLOCK_SIZE + NUM_TAPS - 1*/


/*
*********************************************************************************************************
*	                                 滤波器系数
*********************************************************************************************************
*/
/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 100KHz */
const float32_t firCoeffs32LP_100KHz[NUM_TAPS] = {	
  -3.126438727e-19f,-0.0002058673272f,-0.0004228431499f,-0.0006468905485f,-0.0008642434841f,
  -0.001048665727f,-0.001161655295f,-0.001156177954f,-0.0009838859551f,-0.0006050768425f,
  8.391786605e-19f,0.0008203662583f,  0.00180617522f, 0.002865221584f, 0.003865677863f,
   0.004645895679f, 0.005031134468f, 0.004856021609f,  0.00399050815f, 0.002366269007f,
  -2.110346192e-18f,-0.002989985514f,-0.006377025973f,-0.009831513278f, -0.01293939352f,
    -0.0152332196f, -0.01623356342f, -0.01549717132f, -0.01266706176f,   -0.007519159f,
  3.381513724e-18f, 0.009749332443f,   0.0213866625f,  0.03438147902f,  0.04804687202f,
    0.06158847734f,  0.07416618615f,  0.08496309072f,  0.09325480461f,  0.09847255051f,
     0.1002533659f,  0.09847255051f,  0.09325480461f,  0.08496309072f,  0.07416618615f,
    0.06158847734f,  0.04804687202f,  0.03438147902f,   0.0213866625f, 0.009749332443f,
  3.381513724e-18f,   -0.007519159f, -0.01266706176f, -0.01549717132f, -0.01623356342f,
    -0.0152332196f, -0.01293939352f,-0.009831513278f,-0.006377025973f,-0.002989985514f,
  -2.110346192e-18f, 0.002366269007f,  0.00399050815f, 0.004856021609f, 0.005031134468f,
   0.004645895679f, 0.003865677863f, 0.002865221584f,  0.00180617522f,0.0008203662583f,
  8.391786605e-19f,-0.0006050768425f,-0.0009838859551f,-0.001156177954f,-0.001161655295f,
  -0.001048665727f,-0.0008642434841f,-0.0006468905485f,-0.0004228431499f,-0.0002058673272f,
  -3.126438727e-19f
};

/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 200KHz */
const float32_t firCoeffs32LP_200KHz[NUM_TAPS] = {
  -6.248144429e-19f,-0.0003912865068f,-0.0006836566608f,-0.0007598898374f,-0.0005337275215f,
  8.982911585e-19f,0.0007173990016f, 0.001358139911f, 0.001590756001f, 0.001150053344f,
  -1.677086875e-18f,-0.001559248194f,-0.002920240862f,-0.003365720157f,-0.002387311775f,
  2.842637194e-18f,  0.00310705835f, 0.005704274401f, 0.006451890338f, 0.004497503862f,
  -4.217497399e-18f,-0.005682985298f, -0.01031043474f, -0.01154888794f,-0.007990931161f,
  5.592357604e-18f,  0.01002530009f,  0.01820422709f,    0.020480223f,  0.01429146435f,
  -6.757908027e-18f,  -0.0185302943f,   -0.034578152f, -0.04038725421f, -0.02967212349f,
   7.53670395e-18f,   0.0458025299f,   0.0998044908f,    0.150775224f,   0.1871641278f,
     0.2003549486f,   0.1871641278f,    0.150775224f,   0.0998044908f,   0.0458025299f,
   7.53670395e-18f, -0.02967212349f, -0.04038725421f,   -0.034578152f,  -0.0185302943f,
  -6.757908027e-18f,  0.01429146435f,    0.020480223f,  0.01820422709f,  0.01002530009f,
  5.592357604e-18f,-0.007990931161f, -0.01154888794f, -0.01031043474f,-0.005682985298f,
  -4.217497399e-18f, 0.004497503862f, 0.006451890338f, 0.005704274401f,  0.00310705835f,
  2.842637194e-18f,-0.002387311775f,-0.003365720157f,-0.002920240862f,-0.001559248194f,
  -1.677086875e-18f, 0.001150053344f, 0.001590756001f, 0.001358139911f,0.0007173990016f,
  8.982911585e-19f,-0.0005337275215f,-0.0007598898374f,-0.0006836566608f,-0.0003912865068f,
  -6.248144429e-19f
};

/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 300KHz */
const float32_t firCoeffs32LP_300KHz[NUM_TAPS] = {
  -9.366794733e-19f,-0.0005382481613f,-0.0006832612562f,-0.0002467603481f,0.0005334187881f,
   0.001047265832f,0.0007169840392f,-0.0004410311521f,-0.001589835854f,-0.001581997029f,
  2.514175147e-18f, 0.002144879662f, 0.002918551676f, 0.001092956285f, -0.00238593109f,
  -0.004639693536f, -0.00310526113f, 0.001852359041f, 0.006448158063f, 0.006186702754f,
  -6.322586859e-18f,-0.007817434147f, -0.01030447055f,-0.003750290489f, 0.007986309007f,
    0.01521288417f,  0.01001950074f, -0.00591149088f, -0.02046837471f, -0.01965913549f,
  1.013099795e-17f,  0.02549001016f,  0.03455815092f,  0.01311502419f, -0.02965495922f,
   -0.06150625646f, -0.04577603564f,   0.0324096866f,   0.1506880075f,    0.257460326f,
     0.3003585935f,    0.257460326f,   0.1506880075f,   0.0324096866f, -0.04577603564f,
   -0.06150625646f, -0.02965495922f,  0.01311502419f,  0.03455815092f,  0.02549001016f,
  1.013099795e-17f, -0.01965913549f, -0.02046837471f, -0.00591149088f,  0.01001950074f,
    0.01521288417f, 0.007986309007f,-0.003750290489f, -0.01030447055f,-0.007817434147f,
  -6.322586859e-18f, 0.006186702754f, 0.006448158063f, 0.001852359041f, -0.00310526113f,
  -0.004639693536f, -0.00238593109f, 0.001092956285f, 0.002918551676f, 0.002144879662f,
  2.514175147e-18f,-0.001581997029f,-0.001589835854f,-0.0004410311521f,0.0007169840392f,
   0.001047265832f,0.0005334187881f,-0.0002467603481f,-0.0006832612562f,-0.0005382481613f,
  -9.366794733e-19f
};

/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 400KHz */
const float32_t firCoeffs32LP_400KHz[NUM_TAPS] = {
  -1.248479932e-18f,-0.0006325327558f,-0.000422134588f,0.0004692059301f,0.0008627952193f,
  -1.794930437e-18f,-0.001159708714f,-0.0008386048721f,0.0009822372813f, 0.001859114505f,
  -3.351089814e-18f,-0.002520596841f,-0.001803148654f, 0.002078216989f, 0.003859200282f,
  -5.680047021e-18f, -0.00502270367f,-0.003522193991f, 0.003983821254f, 0.007270423695f,
  -8.427239153e-18f,-0.009186808951f,-0.006366339978f, 0.007131042425f,   0.0129177114f,
  -1.11744317e-17f, -0.01620636135f, -0.01124048699f,  0.01264583599f,  0.02310281433f,
  -1.350338849e-17f, -0.02995507978f, -0.02135082521f,  0.02493774705f,  0.04796636105f,
  -1.505954766e-17f, -0.07404191047f, -0.06162585691f,  0.09309853613f,    0.302559495f,
      0.400341481f,    0.302559495f,  0.09309853613f, -0.06162585691f, -0.07404191047f,
  -1.505954766e-17f,  0.04796636105f,  0.02493774705f, -0.02135082521, -0.02995507978f,
  -1.350338849e-17f,  0.02310281433f,  0.01264583599f, -0.01124048699f, -0.01620636135f,
  -1.11744317e-17f,   0.0129177114f, 0.007131042425f,-0.006366339978f,-0.009186808951f,
  -8.427239153e-18f, 0.007270423695f, 0.003983821254f,-0.003522193991f, -0.00502270367f,
  -5.680047021e-18f, 0.003859200282f, 0.002078216989f,-0.001803148654f,-0.002520596841f,
  -3.351089814e-18f, 0.001859114505f,0.0009822372813f,-0.0008386048721f,-0.001159708714f,
  -1.794930437e-18f,0.0008627952193f,0.0004692059301f,-0.000422134588f,-0.0006325327558f,
  -1.248479932e-18f
};

/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 500KHz */
const float32_t firCoeffs32LP_500KHz[NUM_TAPS] = {
  -1.560243788e-18f,-0.0006649325369f,4.221596079e-18f,0.0007980786613f,-1.999335452e-18f,
  -0.001046669669f,-1.793086652e-18f, 0.001426394214f,-3.273629106e-18f,-0.001954342704f,
  1.228734779e-17f,  0.00264970772f,-5.258387981e-18f,-0.003534867195f,-7.954209302e-18f,
   0.004637052305f,-7.759329686e-18f,-0.005990947131f,3.320187504e-17f, 0.007642831653f,
  -1.053164536e-17f,-0.009657378308f,1.193508217e-17f,   0.0121292863f,-1.330396104e-17f,
   -0.01520422287f,1.460457682e-17f,  0.01911909506f,-1.580490357e-17f, -0.02428619377f,
  1.687538447e-17f,  0.03148944676f,-1.778966224e-17f, -0.04241694883f,1.852522267e-17f,
    0.06147124246f,-1.906395548e-17f,   -0.104820244f,1.939259433e-17f,   0.3180572689f,
      0.500312686f,   0.3180572689f,1.939259433e-17f,   -0.104820244f,-1.906395548e-17f,
    0.06147124246f,1.852522267e-17f, -0.04241694883f,-1.778966224e-17f,  0.03148944676f,
  1.687538447e-17f, -0.02428619377f,-1.580490357e-17f,  0.01911909506f,1.460457682e-17f,
   -0.01520422287f,-1.330396104e-17f,   0.0121292863f,1.193508217e-17f,-0.009657378308f,
  -1.053164536e-17f, 0.007642831653f,3.320187504e-17f,-0.005990947131f,-7.759329686e-18f,
   0.004637052305f,-7.954209302e-18f,-0.003534867195f,-5.258387981e-18f,  0.00264970772f,
  1.228734779e-17f,-0.001954342704f,-3.273629106e-18f, 0.001426394214f,-1.793086652e-18f,
  -0.001046669669f,-1.999335452e-18f,0.0007980786613f,4.221596079e-18f,-0.0006649325369f,
  -1.560243788e-18f
};

/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 600KHz */
const float32_t firCoeffs32LP_600KHz[NUM_TAPS] = {
  -1.871976107e-18f,-0.0006322815898f,0.0004219669499f,0.0004690196074f,-0.000862452609f,
  -1.02656278e-18f, 0.001159248175f,-0.0008382718079f,-0.0009818472899f, 0.001858376199f,
  -5.024638734e-18f,-0.002519595902f, 0.001802432584f, 0.002077391604f,-0.003857667791f,
  2.498802119e-17f, 0.005020709243f,-0.003520795377f,-0.003982239403f, 0.007267536595f,
  -1.263583898e-17f,-0.009183160961f, 0.006363811903f, 0.007128210738f, -0.01291258167f,
  1.675499164e-17f,  0.01619992591f, -0.01123602316f,  -0.0126408143f,  0.02309363894f,
  -2.024704047e-17f, -0.02994318306f,  0.02134234644f,  0.02492784336f, -0.04794731364f,
  2.258035155e-17f,  0.07401250303f, -0.06160138547f, -0.09306156635f,    0.302439332f,
     0.6002737284f,    0.302439332f, -0.09306156635f, -0.06160138547f,  0.07401250303f,
  2.258035155e-17f, -0.04794731364f,  0.02492784336f,  0.02134234644f, -0.02994318306f,
  -2.024704047e-17f,  0.02309363894f,  -0.0126408143f, -0.01123602316f,  0.01619992591f,
  1.675499164e-17f, -0.01291258167f, 0.007128210738f, 0.006363811903f,-0.009183160961f,
  -1.263583898e-17f, 0.007267536595f,-0.003982239403f,-0.003520795377f, 0.005020709243f,
  2.498802119e-17f,-0.003857667791f, 0.002077391604f, 0.001802432584f,-0.002519595902f,
  -5.024638734e-18f, 0.001858376199f,-0.0009818472899f,-0.0008382718079f, 0.001159248175f,
  -1.02656278e-18f,-0.000862452609f,0.0004690196074f,0.0004219669499f,-0.0006322815898f,
  -1.871976107e-18f
};

/* 80阶FIR低通滤波器系数 通过fadtool获取系数 Fs = 2Msps, Fc = 700KHz */
const float32_t firCoeffs32LP_700KHz[NUM_TAPS] = {
  -2.183676374e-18f,-0.0005377779598f,0.0006826643948f,-0.0002465448051f,-0.0005329528358f,
   0.001046351041f,-0.0007163577247f,-0.0004406458756f, 0.001588447019f,-0.001580615062f,
  -2.235691765e-18f, 0.002143006073f, -0.00291600218f, 0.001092001447f,  0.00238384679f,
   -0.00463564042f,  0.00310254842f, 0.001850740984f,-0.006442525424f, 0.006181298289f,
  -1.473981589e-17f,-0.007810604759,  0.01029546931f,-0.003747014562f,-0.007979333401f,
    0.01519959513f, -0.01001074817f,-0.005906326696f,  0.02045049518f,  -0.0196419619f,
  2.361834741e-17f,   0.0254677441f, -0.03452796116f,    0.013103568f,  0.02962905541f,
   -0.06145253032f,  0.04573604837f,  0.03238137811f,  -0.1505563855f,   0.2572354078f,
     0.7002245188f,   0.2572354078f,  -0.1505563855f,  0.03238137811f,  0.04573604837f,
   -0.06145253032f,  0.02962905541f,    0.013103568f, -0.03452796116f,   0.0254677441f,
  2.361834741e-17f,  -0.0196419619f,  0.02045049518f,-0.005906326696f, -0.01001074817f,
    0.01519959513f,-0.007979333401f,-0.003747014562f,  0.01029546931f,-0.007810604759f,
  -1.473981589e-17f, 0.006181298289f,-0.006442525424f, 0.001850740984f,  0.00310254842f,
   -0.00463564042f,  0.00238384679f, 0.001092001447f, -0.00291600218f, 0.002143006073f,
  -2.235691765e-18f,-0.001580615062f, 0.001588447019f,-0.0004406458756f,-0.0007163577247f,
   0.001046351041f,-0.0005329528358f,-0.0002465448051f,0.0006826643948f,-0.0005377779598f,
  -2.183676374e-18f
};

/*
*********************************************************************************************************
*	函 数 名: DSO_FirFilter_Step100KHz
*	功能说明: FIR滤波器。
*	形    参: 无        	
*	返 回 值: 无
*********************************************************************************************************
*/
void DSO_FirFilter_Step100KHz(void)
{
	arm_fir_instance_f32 S;
	uint16_t i;
	
	/* 获取要滤波的数值 */
	for(i = 0; i < BLOCK_SIZE; i++)
	{
		FirDataInput[i] =g_DSO1->usWaveBufTemp[i+g_DSO1->sCurTriPos+g_DSO1->sCurTriStep];
	}
	
	/* FIR低通滤波器，截止频率100KHz */
	if(g_DSO1->ucFirFlter_Step100KHz == 1)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_100KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	/* FIR低通滤波器，截止频率200KHz */
	else if(g_DSO1->ucFirFlter_Step100KHz == 2)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_200KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	/* FIR低通滤波器，截止频率300KHz */
	else if(g_DSO1->ucFirFlter_Step100KHz == 3)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_300KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	/* FIR低通滤波器，截止频率400KHz */
	else if(g_DSO1->ucFirFlter_Step100KHz == 4)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_400KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	/* FIR低通滤波器，截止频率500KHz */
	else if(g_DSO1->ucFirFlter_Step100KHz == 5)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_500KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	/* FIR低通滤波器，截止频率600KHz */
	else if(g_DSO1->ucFirFlter_Step100KHz == 6)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_600KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	/* FIR低通滤波器，截止频率700KHz */
	else if(g_DSO1->ucFirFlter_Step100KHz == 7)
	{
		arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32LP_700KHz[0], &firStateF32[0], BLOCK_SIZE);
	}
	
	/* 80阶FIR滤波 */
	arm_fir_f32(&S, FirDataInput, FirDataOutput, BLOCK_SIZE);
	
	/* 输出滤波器数值 */
	for(i = 0; i < DSOSCREEN_LENGTH; i++)
	{
		g_DSO1->usWaveBuf[i] =FirDataOutput[i+50];
	}
}

/***************************** 安富莱电子 www.armfly.com (END OF FILE) *********************************/
